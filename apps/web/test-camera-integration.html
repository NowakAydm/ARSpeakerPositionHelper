<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #111;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .success {
            background-color: #1a4f37;
            color: #8bc34a;
            border: 1px solid #4caf50;
        }
        .failure {
            background-color: #4a1a1a;
            color: #f44336;
            border: 1px solid #f44336;
        }
        .info {
            background-color: #1a3347;
            color: #2196f3;
            border: 1px solid #2196f3;
        }
        #camera-test-container {
            width: 100%;
            height: 300px;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
            margin: 10px 0;
            position: relative;
        }
        .camera-active {
            align-items: stretch !important;
            justify-content: stretch !important;
        }
        .camera-active .ar-placeholder {
            display: none;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background: #444;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>Camera Integration Test</h1>
    <p>This test verifies the complete camera initialization flow with proper timing.</p>
    
    <!-- External Dependencies - Same as main app -->
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script>
        // Fallback to local mock if CDN fails
        if (!window.THREE) {
            document.write('<script src="vendor/three-mock.js"><\/script>');
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <script>
        // Fallback to local mock if CDN fails
        if (!window.tf || !window.cocoSsd) {
            document.write('<script src="vendor/tf-mock.js"><\/script>');
        }
    </script>

    <div class="test-section">
        <h3>Test: Camera Session Integration</h3>
        <div id="camera-test-container">
            <div class="ar-placeholder">
                <div>üì± Camera View</div>
                <div>Click "Test Camera Integration" to test with real camera API</div>
            </div>
        </div>
        <button onclick="testCameraIntegration()">Test Camera Integration (Real)</button>
        <button onclick="testCameraIntegrationMock()">Test Camera Integration (Mock)</button>
        <button onclick="clearTest()" disabled id="clear-btn">Clear Test</button>
        <div id="test-result"></div>
    </div>

    <div class="test-section">
        <h3>Integration Flow Verification</h3>
        <div id="flow-status">
            <div>1. ‚è≥ Camera permission request</div>
            <div>2. ‚è≥ Permission granted callback</div>
            <div>3. ‚è≥ Video element creation</div>
            <div>4. ‚è≥ Container setup</div>
            <div>5. ‚è≥ Video metadata loaded</div>
            <div>6. ‚è≥ Canvas background setup</div>
            <div>7. ‚è≥ Render loop started</div>
        </div>
    </div>

    <script type="module">
        import { CameraSession } from './src/modules/camera-session.js';

        let cameraSession = null;
        let testContainer = null;

        function updateFlowStatus(step, status) {
            const flowDiv = document.getElementById('flow-status');
            const stepDivs = flowDiv.children;
            if (stepDivs[step - 1]) {
                const statusIcon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
                stepDivs[step - 1].innerHTML = stepDivs[step - 1].innerHTML.replace(/^[‚è≥‚úÖ‚ùå]/, statusIcon);
            }
        }

        window.testCameraIntegration = async function() {
            const resultDiv = document.getElementById('test-result');
            testContainer = document.getElementById('camera-test-container');
            const clearBtn = document.getElementById('clear-btn');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing real camera integration...</div>';
                
                // Reset flow status
                document.getElementById('flow-status').innerHTML = `
                    <div>1. ‚è≥ Camera permission request</div>
                    <div>2. ‚è≥ Permission granted callback</div>
                    <div>3. ‚è≥ Video element creation</div>
                    <div>4. ‚è≥ Container setup</div>
                    <div>5. ‚è≥ Video metadata loaded</div>
                    <div>6. ‚è≥ Canvas background setup</div>
                    <div>7. ‚è≥ Render loop started</div>
                `;
                
                // Create camera session
                cameraSession = new CameraSession();
                
                // Set up permission granted callback to verify timing
                let permissionGrantedCalled = false;
                cameraSession.setPermissionGrantedCallback(() => {
                    permissionGrantedCalled = true;
                    updateFlowStatus(2, 'success');
                    console.log('‚úÖ Permission granted callback executed');
                    
                    // Check if calibration would be enabled
                    if (testContainer.classList.contains('camera-active')) {
                        console.log('‚úÖ Container has camera-active class');
                    } else {
                        console.log('‚ö†Ô∏è Container missing camera-active class');
                    }
                });
                
                updateFlowStatus(1, 'success');
                
                // Initialize camera session
                await cameraSession.initialize(testContainer);
                updateFlowStatus(3, 'success');
                updateFlowStatus(4, 'success');
                
                // Start camera (this will request real permission)
                await cameraSession.start();
                updateFlowStatus(5, 'success');
                updateFlowStatus(6, 'success');
                updateFlowStatus(7, 'success');
                
                // Verify the session state
                const debugStatus = cameraSession.debugCameraStatus();
                
                if (permissionGrantedCalled) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ SUCCESS: Camera integration working correctly</div>';
                    resultDiv.innerHTML += '<div class="info">Permission granted callback was executed immediately</div>';
                    resultDiv.innerHTML += '<div class="info">Camera session initialized with proper timing</div>';
                } else {
                    resultDiv.innerHTML = '<div class="failure">‚ùå PARTIAL: Camera started but permission callback timing issue</div>';
                }
                
                clearBtn.disabled = false;
                
            } catch (error) {
                updateFlowStatus(1, 'error');
                resultDiv.innerHTML = `<div class="failure">‚ùå FAILED: ${error.message}</div>`;
                
                if (error.message.includes('denied') || error.message.includes('NotAllowedError')) {
                    resultDiv.innerHTML += '<div class="info">This is expected - camera permission was denied. Try the mock test instead.</div>';
                } else if (error.message.includes('not found') || error.message.includes('NotFoundError')) {
                    resultDiv.innerHTML += '<div class="info">This is expected - no camera available. Try the mock test instead.</div>';
                }
            }
        };

        window.testCameraIntegrationMock = async function() {
            const resultDiv = document.getElementById('test-result');
            testContainer = document.getElementById('camera-test-container');
            const clearBtn = document.getElementById('clear-btn');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing camera integration with mock...</div>';
                
                // Reset flow status
                document.getElementById('flow-status').innerHTML = `
                    <div>1. ‚è≥ Camera permission request</div>
                    <div>2. ‚è≥ Permission granted callback</div>
                    <div>3. ‚è≥ Video element creation</div>
                    <div>4. ‚è≥ Container setup</div>
                    <div>5. ‚è≥ Video metadata loaded</div>
                    <div>6. ‚è≥ Canvas background setup</div>
                    <div>7. ‚è≥ Render loop started</div>
                `;
                
                // Create working mock stream
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                
                let frame = 0;
                const drawFrame = () => {
                    ctx.fillStyle = '#001122';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(50 + Math.sin(frame * 0.1) * 50, 100, 50, 50);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '16px Arial';
                    ctx.fillText(`Frame ${frame}`, 50, 50);
                    frame++;
                };
                
                const interval = setInterval(drawFrame, 100);
                const mockStream = canvas.captureStream(10);
                
                // Mock getUserMedia
                const originalGetUserMedia = navigator.mediaDevices.getUserMedia;
                navigator.mediaDevices.getUserMedia = async function(constraints) {
                    console.log('üé• Mock getUserMedia called');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    return mockStream;
                };
                
                updateFlowStatus(1, 'success');
                
                // Create camera session
                cameraSession = new CameraSession();
                
                // Set up permission granted callback
                let permissionGrantedCalled = false;
                cameraSession.setPermissionGrantedCallback(() => {
                    permissionGrantedCalled = true;
                    updateFlowStatus(2, 'success');
                    console.log('‚úÖ Permission granted callback executed');
                });
                
                // Initialize and start
                await cameraSession.initialize(testContainer);
                updateFlowStatus(3, 'success');
                updateFlowStatus(4, 'success');
                
                await cameraSession.start();
                updateFlowStatus(5, 'success');
                updateFlowStatus(6, 'success');
                updateFlowStatus(7, 'success');
                
                // Restore original getUserMedia
                navigator.mediaDevices.getUserMedia = originalGetUserMedia;
                
                if (permissionGrantedCalled && testContainer.classList.contains('camera-active')) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ SUCCESS: Complete camera integration flow verified</div>';
                    resultDiv.innerHTML += '<div class="success">‚úÖ Permission granted callback timing correct</div>';
                    resultDiv.innerHTML += '<div class="success">‚úÖ Container properly activated</div>';
                    resultDiv.innerHTML += '<div class="success">‚úÖ Canvas and video elements created</div>';
                } else {
                    resultDiv.innerHTML = '<div class="failure">‚ùå FAILED: Integration flow incomplete</div>';
                }
                
                clearBtn.disabled = false;
                
                // Clean up
                setTimeout(() => {
                    clearInterval(interval);
                }, 5000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="failure">‚ùå FAILED: ${error.message}</div>`;
            }
        };

        window.clearTest = function() {
            const clearBtn = document.getElementById('clear-btn');
            
            if (cameraSession) {
                cameraSession.stop();
                cameraSession = null;
            }
            
            testContainer.innerHTML = `
                <div class="ar-placeholder">
                    <div>üì± Camera View</div>
                    <div>Click "Test Camera Integration" to test with real camera API</div>
                </div>
            `;
            testContainer.classList.remove('camera-active');
            clearBtn.disabled = true;
            
            document.getElementById('test-result').innerHTML = '<div class="info">Test cleared</div>';
            
            // Reset flow status
            document.getElementById('flow-status').innerHTML = `
                <div>1. ‚è≥ Camera permission request</div>
                <div>2. ‚è≥ Permission granted callback</div>
                <div>3. ‚è≥ Video element creation</div>
                <div>4. ‚è≥ Container setup</div>
                <div>5. ‚è≥ Video metadata loaded</div>
                <div>6. ‚è≥ Canvas background setup</div>
                <div>7. ‚è≥ Render loop started</div>
            `;
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Camera integration test page loaded');
        });
    </script>
</body>
</html>